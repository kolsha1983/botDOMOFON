<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–æ–º–æ—Ñ–æ–Ω–Ω—ã–µ –∫–ª—é—á–∏ ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 20px;
      background-color: #f9f9f9;
      color: #333;
    }
    h1 { color: #2c3e50; }
    .controls {
      margin: 15px 0;
    }
    button {
      padding: 8px 12px;
      margin-right: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .search-box {
      padding: 8px;
      width: 300px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #ecf0f1;
      position: sticky;
      top: 0;
    }
    tr:hover td { background-color: #f5f5f5; }
    td[contenteditable="true"] {
      outline: 1px dashed #3498db;
      cursor: text;
    }
    #status {
      margin-bottom: 10px;
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>üîë –î–æ–º–æ—Ñ–æ–Ω–Ω—ã–µ –∫–ª—é—á–∏ ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä</h1>
  <div id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

  <div class="controls">
    <input type="text" id="search" class="search-box" placeholder="–ü–æ–∏—Å–∫..." />
    <button onclick="addRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    <button onclick="exportToExcel()">üíæ –°–∫–∞—á–∞—Ç—å Excel</button>
  </div>

  <div id="table-container"></div>

  <script>
    let data = [];
    const headers = ['–ê–¥—Ä–µ—Å', '–ö–æ–¥', '–ß–∞—Å—Ç–æ—Ç–∞', '–ü–æ–¥—ä–µ–∑–¥—ã'];

    // –ó–∞–≥—Ä—É–∑–∫–∞ Excel
    async function loadExcel() {
      try {
        const response = await fetch('domofon.xlsx');
        if (!response.ok) throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
        const ab = await response.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { header: 1 });

        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
        const rows = json.slice(1).filter(row =>
          row && row.length > 0 && row.some(cell => String(cell).trim())
        );

        data = rows.map(row => {
          const obj = {};
          headers.forEach((h, i) => {
            obj[h] = (row[i] !== undefined && row[i] !== null) ? String(row[i]).trim() : '';
          });
          return obj;
        });

        document.getElementById('status').textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π`;
        renderTable();
      } catch (err) {
        console.error(err);
        document.getElementById('status').textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
      }
    }

    function renderTable(filteredData = null) {
      const displayData = filteredData || data;
      if (displayData.length === 0) {
        document.getElementById('table-container').innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';
        return;
      }

      let html = `<table><thead><tr>`;
      headers.forEach(h => html += `<th>${h}</th>`);
      html += `<th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>`;

      displayData.forEach((row, idx) => {
        html += `<tr data-index="${idx}">`;
        headers.forEach(h => {
          html += `<td contenteditable="true" data-field="${h}">${row[h]}</td>`;
        });
        html += `<td><button onclick="deleteRow(${idx})">üóë –£–¥–∞–ª–∏—Ç—å</button></td></tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById('table-container').innerHTML = html;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
      document.querySelectorAll('td[contenteditable="true"]').forEach(cell => {
        cell.addEventListener('blur', function() {
          const idx = this.closest('tr').dataset.index;
          const field = this.dataset.field;
          data[idx][field] = this.textContent.trim();
        });
      });
    }

    function addRow() {
      const newRow = {};
      headers.forEach(h => newRow[h] = '');
      data.push(newRow);
      renderTable();
    }

    function deleteRow(index) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?')) {
        data.splice(index, 1);
        renderTable();
      }
    }

    function exportToExcel() {
      if (data.length === 0) {
        alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
      }

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤
      const wsData = [headers];
      data.forEach(row => {
        wsData.push(headers.map(h => row[h] || ''));
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '–î–æ–º–æ—Ñ–æ–Ω—ã');

      // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
      XLSX.writeFile(wb, 'domofon_updated.xlsx');
    }

    document.getElementById('search').addEventListener('input', function() {
      const q = this.value.toLowerCase().trim();
      if (!q) {
        renderTable();
        return;
      }
      const filtered = data.filter(row =>
        Object.values(row).some(val => val.toLowerCase().includes(q))
      );
      renderTable(filtered);
    });

    // –ó–∞–ø—É—Å–∫
    loadExcel();
  </script>

</body>
</html>
